## 扫盲

感觉先使用后有了去学习分布式理论的驱动。



**Q1：在集群环境下使用nginx做代理，和在分布式环境下的服务注册中心。这些服务器中间件的压力一定很大吧**       

> 在集群环境下使用nginx做代理和在分布式环境下使用服务注册中心是常见的高可用架构设计方法，这些中间件的确会承受一定的压力，但是它们的设计和实现都有一些优化措施来减轻压力。
>
> 对于nginx代理，它可以通过多个worker进程来处理请求，每个worker进程可以处理多个并发连接，从而提高并发处理能力。此外，nginx还可以通过使用缓存来减少对后端服务的请求，从而降低负载压力。另外，nginx还支持动态扩容和负载均衡，可以根据实际负载情况自动调整代理服务器的数量，以提高系统的可用性和扩展性。
>
> 对于服务注册中心，它可以通过使用分布式缓存来提高性能和可靠性。服务注册中心通常使用ZooKeeper、Etcd等分布式存储来存储服务实例的状态信息，这些分布式存储具有高可用性和数据一致性，可以确保服务注册中心的可用性和稳定性。此外，服务注册中心还可以使用**心跳检测**等机制来监控服务实例的健康状态，及时发现故障和异常情况，并进行相应的处理。
>
> 总的来说，在集群和分布式环境中，中间件的设计和实现都会考虑到高并发和高可用的需求，采用了一系列的优化措施来减轻负载压力和提高系统的可用性和扩展性。但是，需要注意的是，在实际应用中，还需要根据具体的场景和需求进行合理的配置和优化，以确保系统的稳定性和高性能。
>
> end: （为什么不自己开发？）中间件本身是由经验丰富的开发人员和团队开发和维护的，它们在设计和实现时会考虑到各种情况和需求，以确保其可靠性和高性能。因此，相对于自己开发的服务，中间件具有更高的可靠性和稳定性。

**Q2：为什么需要这些中间件，可以列举一些中间件和使用场景吗**        

> 中间件是指位于应用程序和操作系统之间的软件，用于协调和管理应用程序和系统之间的交互。它们可以提供各种功能和服务，例如负载均衡、缓存、消息队列、服务注册和发现、日志管理等，可以提高系统的性能、可靠性和可扩展性。

我的理解，服务器中间件比如目前使用过的nginx/redis/zookeeper，这些本身不作为我们整体系统的业务实现，而是作为具体的/成熟的解决方案。而且他们本身就是高可用的，比自己编写好得多。从架构来上看就是计算机里面经典的加上一层！

> 以下是一些常见的中间件及其使用场景：
>
> 1. Nginx：Nginx是一款**高性能的Web服务器和反向代理服务器**，可以用于负载均衡、静态资源缓存、SSL终止、HTTP缓存、反向代理等场景。
> 2. Apache：Apache是一款广泛使用的Web服务器，可以用于处理静态和动态内容、负载均衡、反向代理、安全认证等场景。
> 3. Redis：Redis是一款高性能的缓存和数据存储服务，可以用于缓存、会话存储、**消息队列**等场景。
> 4. RabbitMQ：RabbitMQ是一款开源的消息队列中间件，可以用于异步消息处理、解耦、削峰等场景。
> 5. ZooKeeper：ZooKeeper是一款开源的分布式协调服务，可以用于服务注册和发现、分布式锁、配置管理等场景。
> 6. Consul：Consul是一款开源的服务注册和发现中间件，可以用于服务注册和发现、健康检查、负载均衡等场景。
> 7. Elasticsearch：Elasticsearch是一款开源的分布式搜索和分析引擎，可以用于日志管理、搜索引擎、业务分析等场景.
>
> 总之，中间件可以提供各种功能和服务，可以帮助开发人员构建高性能、可靠和可扩展的应用程序。开发人员需要根据实际应用场景选择合适的中间件，并对其进行合理配置和优化，以确保系统的性能、可靠性和可扩展性。



## 单体-集群-分布式

随着互联网的发展，单体架构逐渐不再能够满足需求，分布式架构成为了发展的趋势。后端架构经历了单体架构、集群架构、微服务/分布式架构的演进。

1. 单体架构 单体架构是最早期的后端架构模式，也是最简单的一种模式。所有的功能模块都集中在一个应用中，这个应用负责处理所有的请求和业务逻辑。单体架构的好处是开发和部署比较简单，但随着业务的增长，单体应用的复杂度和维护成本也随之增加。单体架构的应用容易出现性能瓶颈和单点故障，难以满足高可用和高并发的需求。
2. 集群架构 集群架构是一种在单体架构基础上的扩展模式。通过将单体应用部署在多台服务器上，同时通过负载均衡实现请求的分发，来提高应用的可用性和并发能力。但是，集群架构仍然存在一些问题。例如，需要对所有服务器进行统一的配置和管理，单个服务器出现问题会影响整个集群的运行。
3. 微服务/分布式架构 微服务/分布式架构是一种基于服务的架构模式，将应用拆分成多个小型服务。每个服务都可以独立部署、独立升级、独立扩展，并通过轻量级的通信机制进行交互。这种架构模式具有很好的可扩展性和可维护性，适合于大型复杂应用的开发和部署。但是，微服务架构也需要面对一些挑战，例如服务治理、服务发现、服务监控等。



## 集群与分布式

单体==》集群==》微服务/分布式

cluster 和 distributed 不是两个对立的概念，一个系统既可以有分布式也可以有集群。

分布式环境下有CAP理论。

集群环境下同样需要考虑系统的容错性，比如水平拓展下节点down了，当然集群不等于水平拓展。（集群的容错性）

**集群与分布式：**

> 当需要处理海量数据或者高并发请求时，单台服务器的处理能力可能会有限，因此常常会使用集群或分布式架构来提升系统性能和可靠性。
>
> 集群(Cluster)是由多台计算机组成的一个集合，这些计算机之间通过网络进行通信，共同完成某个任务。集群通常采用**对等通信方式**，每个节点都有相同的地位，没有主从关系。在集群中，每个节点可以通过共享存储或者数据同步的方式来实现数据共享。
>
> 分布式系统(Distributed System)是指由多个节点（进程或者计算机）通过网络连接组成的系统，这些节点协同工作完成某个任务。分布式系统中的每个节点可以独立地运行、处理数据，并**与其他节点进行通信和协调，形成一个整体**。分布式系统通常采用异步消息传递的方式进行通信，数据分布在不同节点上，节点之间需要通过网络传递数据。
>
> 总的来说，集群和分布式架构都是为了提高系统的可靠性、可扩展性和性能，但是在实际应用中，选择哪种架构需要根据具体的业务场景、数据规模、负载情况等因素来综合考虑。

**集群一般就是单体的直接水平扩展吗，我说的对吗**    

> 集群并不等同于单体应用的水平扩展，尽管它们在某些方面可能会有相似之处。
>
> 单体应用的水平扩展是指将应用部署在多台服务器上，并通过负载均衡将请求分发到不同的服务器上，从而提高应用的吞吐量和可用性。在这种架构下，多个服务器共同处理同一份代码和数据。
>
> 而集群是指将多台计算机通过网络连接在一起，形成一个整体，可以共同完成某个任务。集群的节点可以具有不同的角色和功能，例如负责数据存储、处理、计算等。在集群中，节点之间通过网络通信进行协作，数据通常会被分布在不同的节点上。相比于单体应用的水平扩展，集群更加灵活，可以根据需要调整集群的规模，同时也更加适合大规模数据处理和高并发请求场景。
>
> 虽然集群和单体应用的水平扩展都可以提高应用的性能和可用性，但是它们的实现方式和应用场景有所不同。在实际应用中，需要根据具体的业务需求来选择合适的架构和扩展方式。



## nginx

目前只使用过作为集群服务器的反向代理，但是nginx最强大的还是高并发的web服务器。

集群与分布式，集群服务器的水平拓展



## redis

使用的客户端sdk是hiredis。

目前使用过它的发布订阅机制作为MQ。

redis的配置`/etc/redis/`读一下就可以解决你大部分的疑惑，其他的同样可以这个模式学习。

redis的部署方式可以和MySQL类似，都作为数据库服务器，redis的配置文件里面`bind 127.0.0.1`只允许本地登录。当然这个是可以改的。

**Q1：redis的部署，应该和本地后端服务在一个主机还是 一个内网**

> Redis的部署可以和本地后端服务在同一主机上，也可以在内网中的其他主机上。这取决于你的应用程序的要求以及负载的大小。
>
> 如果你的应用程序只需要处理少量的数据，并且不需要太高的可靠性和性能，可以考虑在同一台主机上部署Redis和后端服务。这种部署方式的优点是部署简单，易于管理，可以减少网络延迟，并且可以节省一些服务器成本。但是，如果你的应用程序需要处理大量的数据或需要高可靠性和高性能，则不建议使用这种部署方式。
>
> 另一种部署方式是将Redis部署在内网中的其他主机上，这可以提高可靠性和性能。在这种部署方式中，Redis和后端服务可以在不同的主机上运行，它们之间通过内网通信。这种部署方式的优点是可以提高可靠性和性能，并且可以将负载分摊到不同的主机上，从而更好地支持扩展性。但是，这种部署方式需要更多的配置和管理，并且需要一些网络知识来配置和管理内网。

**Q2：生产环境下redis的配置**    

> 在生产环境中，Redis的配置需要注意以下几点：
>
> 1. 设置密码：在Redis配置文件中设置`requirepass`选项来设置密码，以限制远程访问。
> 2. 持久化：在Redis配置文件中设置`save`选项来设置持久化策略。Redis支持多种持久化方式，如RDB和AOF。对于重要的数据，建议使用AOF方式进行持久化。
> 3. 内存管理：在Redis配置文件中设置`maxmemory`选项来设置Redis实例最大使用内存大小。同时，也可以设置`maxmemory-policy`选项来设置缓存淘汰策略。对于内存敏感的应用程序，建议将Redis部署在具有足够内存容量的服务器上，并根据应用程序的内存使用情况动态调整Redis的内存配置。
> 4. 高可用性：Redis支持多种高可用性方案，如主从复制和哨兵模式。可以根据应用程序的要求选择合适的高可用性方案。在主从复制方案中，可以将Redis服务器配置为主节点和从节点，从节点将复制主节点的数据以实现数据备份和容灾。在哨兵模式中，可以使用Redis Sentinel实现自动故障转移和节点监控。
> 5. 网络安全：在生产环境中，应确保Redis服务器的网络安全。可以通过限制Redis服务器所在的服务器或网络的访问权限，或者使用其他网络安全措施来保护Redis服务器免受攻击。
> 6. 性能调优：可以根据应用程序的负载和性能要求，调整Redis的配置参数，以优化性能。例如，可以调整Redis线程池大小，设置最大连接数，以及使用其他性能调优技术，如分片和缓存预热等。
>
> 总之，在生产环境中，需要根据实际情况进行Redis配置，以保证Redis的安全性、可靠性和性能。同时，也需要定期监控Redis服务器的运行情况，以及进行必要的维护和优化。
>
>   
>
> 默认情况下，redis-cli的登录不需要密码；但是这是可设置的。
>
> redis-server也可以支持远程访问，同样是需要配置；但是redis最好还是内外访问。

还有一个疑惑就是通过redis-cli设置的k-v有效时间是多久？默认的都是持久化了吗？==》可以设置expire，不然全是持久化了的。

### 生产环境配置

如果有其他的主机要访问redis服务器，就得进行相关的配置，比如绑定的IP+PORT。然后还要添加redis服务器的密码，redis和MySQL不一样它，redis没有用户知道密码登录即可。

```bash
# IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES
# COMMENT OUT THE FOLLOWING LINE.
#
# You will also need to set a password unless you explicitly disable protected
# mode.
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
bind 127.0.0.1 -::1
# By default protected mode is enabled. You should disable it only if
# you are sure you want clients from other hosts to connect to Redis
# even if no authentication is configured.
protected-mode yes

#设置密码
requirepass mypwd
```

配置后就需要密码才能执行一些redisAPI，但是生产环境都是和部署在同一台主机，毕竟是一个内存型数据库。

`redis-cli  -a myPwd`进行使用。

### 一些命令

redis是一个k-v的nosql数据库，其中key的类型都是字符串，而value的类型主要有5种。不同类型的value有不同的操作API，比如字符串就很简单仅仅`get/set`即可。

```bash
keys * # 线上禁止使用，会遍历所有的key
del key #对所有的value对应的键都适应。
type key
exists key
set hello wrold # only for string
expire key seconds #对所有的键值类型都适用
ttl key #查看一个key的过期时间
object encoding key #查看一个key对应数据的编码方式
```

下面介绍具体的数据结构及其操作API。redis没有数字/number，但是可以用string。

redis单线程为什么还快？

可以把redis的key看作是一个容器的名字。

### string

先学会通过redis-cli学习相关的基础API，再开始深入的学习。

```bash
get key
set key value ex seconds nn
setnx key value
set key value xx
strlen key
setrange key offset value #设置一个字符
mset #multi get一次redis命令设置
mget #multi set一次redis命令获取
```

### hash

redis里面一个hash容器的pair叫做`field-->value`。

redis是一个k-v数据库，每个key为字符串类型代表了一个*容器*的名字。

可以说就是一个内存数据结构服务器，先熟悉使用*crud*，然后深入。

```bash
hset key field value #创建
hget key field       #获取
del key
hdel key field
hmget key field1 field2
hmset key field value [f v]
hkeys key #返回一个hash容器里面所有的field
hvals key #返回一个hash容器里面所有的values
hgetall key #返回一个key所有的field-value
```

### list

list就是一个类似于deque的东西，所以有`rpush lpush rpop lpop`。

当一个list为空的时候会自动删除，除了string都会被自动删除。

这些CRUD的api写的挺明白，练练即可，忘了看看。

### set

set为空应该也会直接删除，支持一些集合的公共操作比如交集、并集、差集，集合不支持下标操作。

```bash
exists myset
sadd myset a b c
srem myset a b
sismember myset a
spop myset
```

### zset



redis的事务就比较简单了。

## zookeeper

分布式rpc服务的注册中心。https://www.cnblogs.com/xinyonghu/p/11031729.html

目前的项目里面的应用更像是一个文件服务器，用来保存各个节点的配置。       

当一个rpc-service部署三份，向zookeeper注册的时候如何组织？



### 线上环境配置

作为rpc服务的发布-发现中心，肯定是需要rpc调用者进行访问的。这就需要配置zookeeper的一些安全验证方面的比如用户和密码。
